<!DOCTYPE html>
<html lang="zh-cn">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    
    <title>瞎扯中的山坡驴</title>
    <meta name="viewport" content="width=device-width,minimum-scale=1">
    <meta name="description" content="山坡驴真的在瞎扯啊瞎扯啊瞎扯。。。">
    <meta name="generator" content="Hugo 0.91.2" />
    
    
      <META NAME="ROBOTS" CONTENT="NOINDEX, NOFOLLOW">
    

    
<link rel="stylesheet" href="https://sempr.github.io/ananke/css/main.min.css" >



    
    
    
      

    

    
    
      <link href="https://sempr.github.io/index.xml" rel="alternate" type="application/rss+xml" title="瞎扯中的山坡驴" />
      <link href="https://sempr.github.io/index.xml" rel="feed" type="application/rss+xml" title="瞎扯中的山坡驴" />
      
    
    
    <meta property="og:title" content="瞎扯中的山坡驴" />
<meta property="og:description" content="山坡驴真的在瞎扯啊瞎扯啊瞎扯。。。" />
<meta property="og:type" content="website" />
<meta property="og:url" content="https://sempr.github.io/" />

<meta itemprop="name" content="瞎扯中的山坡驴">
<meta itemprop="description" content="山坡驴真的在瞎扯啊瞎扯啊瞎扯。。。"><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="瞎扯中的山坡驴"/>
<meta name="twitter:description" content="山坡驴真的在瞎扯啊瞎扯啊瞎扯。。。"/>

	
  </head>

  <body class="ma0 avenir bg-near-white">

    

  <header>
    <div class="pb3-m pb6-l bg-black">
      <nav class="pv3 ph3 ph4-ns" role="navigation">
  <div class="flex-l justify-between items-center center">
    <a href="https://sempr.github.io/" class="f3 fw2 hover-white no-underline white-90 dib">
      
        瞎扯中的山坡驴
      
    </a>
    <div class="flex-l items-center">
      

      
      
<div class="ananke-socials">
  
</div>
    </div>
  </div>
</nav>

      <div class="tc-l pv3 ph3 ph4-ns">
        <h1 class="f2 f-subheadline-l fw2 light-silver mb0 lh-title">
          瞎扯中的山坡驴
        </h1>
        
      </div>
    </div>
  </header>


    <main class="pb7" role="main">
      
 <article class="cf ph3 ph5-l pv3 pv4-l f4 tc-l center measure-wide lh-copy mid-gray">
    
  </article>
  
  
  
  
  
  
  
    
    

    <div class="pa3 pa4-ns w-100 w-70-ns center">
      
       
          <h1 class="flex-none">
            Recent Posts
          </h1>
        

      

      <section class="w-100 mw8">
        
        
          <div class="relative w-100 mb4">
            
<article class="bb b--black-10">
  <div class="db pv4 ph3 ph0-l no-underline dark-gray">
    <div class="flex flex-column flex-row-ns">
      
      <div class="blah w-100">
        <h1 class="f3 fw1 athelas mt0 lh-title">
          <a href="https://sempr.github.io/posts/weixin-bot/" class="color-inherit dim link">
            如何开通淘宝客账号并且获取到pid
            </a>
        </h1>
        <div class="f6 f5-l lh-copy nested-copy-line-height nested-links">
            开通账号
访问淘宝联盟，用淘宝账号登录，此处推荐使用手机淘宝扫码登录
  创建推广渠道
访问媒体管理，创建一个导购推广，内容随便填写。
如果有遇到需要实名认证的，请参照提示操作，首次开通可能需要一个小时左右(实际可能很快)，等开通后可继续下一步。
  创建推广位
访问我要推广，鼠标随便放到一个商品上，会看到有&quot;立即推广&quot;的按钮，点一下，会弹出窗口，从上到下分别选择 导购推广&gt;刚才创建的导购名称-&gt;新建推广位-&gt;随便写个名字，点确定
  获取pid
访问推广位管理，复制pid一列的内容
  
        </div>
          <a href="https://sempr.github.io/posts/weixin-bot/" class="ba b--moon-gray bg-light-gray br2 color-inherit dib f7 hover-bg-moon-gray link mt2 ph2 pv1">read more</a>
        
      </div>
    </div>
  </div>
</article>

          </div>
        
          <div class="relative w-100 mb4">
            
<article class="bb b--black-10">
  <div class="db pv4 ph3 ph0-l no-underline dark-gray">
    <div class="flex flex-column flex-row-ns">
      
      <div class="blah w-100">
        <h1 class="f3 fw1 athelas mt0 lh-title">
          <a href="https://sempr.github.io/posts/fix-broken-virtualenv-python/" class="color-inherit dim link">
            修复python升级后导致的virtualenv中的python无法正常运行
            </a>
        </h1>
        <div class="f6 f5-l lh-copy nested-copy-line-height nested-links">
          去往virtualenv的目录，执行下面的命令
# 确定当前的版本，查找到对应目录的所有软链并且删掉后 重建新的软链 CUR_PY=`readlink bin/python` find . -type l -delete virtualenv . -p $CUR_PY 
        </div>
          <a href="https://sempr.github.io/posts/fix-broken-virtualenv-python/" class="ba b--moon-gray bg-light-gray br2 color-inherit dib f7 hover-bg-moon-gray link mt2 ph2 pv1">read more</a>
        
      </div>
    </div>
  </div>
</article>

          </div>
        
          <div class="relative w-100 mb4">
            
<article class="bb b--black-10">
  <div class="db pv4 ph3 ph0-l no-underline dark-gray">
    <div class="flex flex-column flex-row-ns">
      
      <div class="blah w-100">
        <h1 class="f3 fw1 athelas mt0 lh-title">
          <a href="https://sempr.github.io/posts/docker_with_iptables/" class="color-inherit dim link">
            重启iptables导致的docker容器工作不正常问题原因及解决方法
            </a>
        </h1>
        <div class="f6 f5-l lh-copy nested-copy-line-height nested-links">
          阿里云的云盾报了很多次线上用的centos因为有段时间没有更新导致的出现了很多的漏洞需要打补丁，所以在某台机器上做了一把yum upgrade更新系统，完毕之后发现sentry上面突然报了大量的访问超时的错误，这样的事情其实从以往到现在发生过了不只一次了，解决方法都是重启机器，一直也没有云太深究其中的问题，今天下了决心准备云探查一番。
初步的猜测是更新的时候如果更新到了iptables-service，会导致iptables.service的重启，重启会清掉所有的iptables的配置项并且加载系统预置的配置，而docker自己在启动的时候也会加载一批配置项以保证自己的内部容器可以正常使用网络，是否是因为这批iptables的配置项被清掉了导致docker启动的服务无法被外边访问? 实际情况还需要通过实验来判断了。
在阿里云开通了一台按量付费的服务器(最低配置, 4分钱一小时)，安装好iptables和docker开始实验。
  先部署一个容器
docker run -d --restart always -p 8080:80 --name nginx nginx:alpine
  然后测试访问这个nginx
curl http://127.0.0.1:8080/
根据刚才的猜测，这个是可以正常访问得了的
  重启iptables, 测试服务可访问性
systemctl restart iptables
这个时候通过 iptables-save 可以看到配置的条目数量只有几条了，和docker相关的部分全部都被清空了，按之前的猜测，这个时候nginx应该是无法正常访问的，于是我执行了一下curl http://127.0.0.1:8080/，居然可以正常访问，所以之前的猜测是有偏差的。从netstat的信息来看, 8080端口是被一个叫做docker-proxy的进程开启的，和iptables没有什么关联，所以正常访问也算是合情合理的，那到底是什么原因导致的服务挂掉的呢，是不是容器内部的服务连网的能力受限呢？
  测试容器内访问网络的情况
执行了一下 docker exec -ti nginx wget -O- www.baidu.com 果然失败了，失败信息为wget: bad address 'www.baidu.com'
  再次重启docker让docker把自己的那堆iptables配置重新生效之后，执行上一步的命令可以正常访问网络了。
  所以，问题现在应该算是已经找到了，确实是iptables.service的服务重启导致清理掉了可以让容器内部访问外部网络的能力失效，直接的解决办法很简单，在iptables服务重启的时候，手动的把docker重启一把就可以了。
那么，有没有更加方便的办法让docker自动的跟着iptables.service重启呢? 办法是有的，在centos中，配置一下systemd的启动参数，让iptables的重启自动的把docker重启一下即可。
下面是docker的systemd配置文件中的Unit模块的配置，最后一行是
[Unit] Description=Docker Application Container Engine Documentation=https://docs.docker.com After=network-online.target firewalld.service iptables.service Wants=network-online.
        </div>
          <a href="https://sempr.github.io/posts/docker_with_iptables/" class="ba b--moon-gray bg-light-gray br2 color-inherit dib f7 hover-bg-moon-gray link mt2 ph2 pv1">read more</a>
        
      </div>
    </div>
  </div>
</article>

          </div>
        
      </section>

      
      <section class="w-100">
        <h1 class="f3">More</h1>
        
        
          <h2 class="f5 fw4 mb4 dib mr3">
            <a href="https://sempr.github.io/posts/hugo_travisci_github_pages/" class="link black dim">
              利用Travis CI自动部署hugo生成的静态页面到github pages
            </a>
          </h2>
        
          <h2 class="f5 fw4 mb4 dib mr3">
            <a href="https://sempr.github.io/posts/mtr_none_root_mac/" class="link black dim">
              MTR v0.92(以及后续版本) 在mac下的非root帐号下使用
            </a>
          </h2>
        
          <h2 class="f5 fw4 mb4 dib mr3">
            <a href="https://sempr.github.io/posts/mongodb_index_hint/" class="link black dim">
              Mongodb的count不走索引的问题及解决
            </a>
          </h2>
        
          <h2 class="f5 fw4 mb4 dib mr3">
            <a href="https://sempr.github.io/posts/pillow_dup_opacity/" class="link black dim">
              Pillow给图片打水印透明度叠加问题
            </a>
          </h2>
        

        
        
          <a href="https://sempr.github.io/posts/" class="link db f6 pa2 br3 bg-mid-gray white dim w4 tc">All Posts</a>
        
        </section>
      

      </div>
  

    </main>
    <footer class="bg-black bottom-0 w-100 pa3" role="contentinfo">
  <div class="flex justify-between">
  <a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="https://sempr.github.io/" >
    &copy;  瞎扯中的山坡驴 2022 
  </a>
    <div>
<div class="ananke-socials">
  
</div></div>
  </div>
</footer>

  </body>
</html>
